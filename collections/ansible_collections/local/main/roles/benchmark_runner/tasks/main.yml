---
# Role: benchmark_runner
# Description: Executes gas benchmarks for a single client using run.sh script

- name: Log benchmark execution phase
  ansible.builtin.debug:
    msg: "========== Benchmark Execution Phase: {{ client_name }} =========="

- name: Log benchmark images configuration
  ansible.builtin.debug:
    msg: "benchmark_images: {{ benchmark_images | to_json }}"

- name: Clean up stale genesis files from /tmp
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/chainspec.json
  failed_when: false

- name: Execute benchmark for {{ client_name }}
  block:
    - name: Extract test path from first test (simplified for single path)
      ansible.builtin.set_fact:
        primary_test_path: "{{ benchmark_test_paths[0].path | regex_replace('^' + benchmark_tests_root + '/', '') }}"
        primary_genesis: "{{ benchmark_test_paths[0].genesis | default('') }}"

    - name: Build run.sh command (using legacy -t format)
      ansible.builtin.set_fact:
        run_command: >-
          bash run.sh
          -t "{{ primary_test_path }}"
          {{ '-g ' + primary_genesis if primary_genesis != '' else '' }}
          -c "{{ client_name }}"
          -r {{ benchmark_runs }}
          {{ '-w "' + benchmark_warmup_file + '"' if (benchmark_warmup_file is defined and benchmark_warmup_file != '') else '' }}
          {{ '-f "' + benchmark_filter + '"' if (benchmark_filter is defined and benchmark_filter != '') else '' }}
          {{ '-n "' + benchmark_network + '"' if (benchmark_network is defined and benchmark_network != '') else '' }}
          {{ '-B "' + benchmark_snapshot_root + '"' if (benchmark_snapshot_root is defined and benchmark_snapshot_root != '') else '' }}
          {{ '-R' if benchmark_restart_before_testing | default(false) else '' }}
          {{ '-F' if benchmark_skip_forkchoice | default(false) else '' }}
          {{ '-o ' + benchmark_opcodes_warmup_count | string if (benchmark_opcodes_warmup_count is defined and benchmark_opcodes_warmup_count > 0) else '' }}
          {{ "-i '" + (benchmark_images | to_json) + "'" if (benchmark_images | default({}) | length > 0) else '' }}

    - name: Log benchmark command construction
      ansible.builtin.debug:
        msg: "Benchmark command for {{ client_name }}: {{ run_command }}"

    - name: Log benchmark execution start
      ansible.builtin.debug:
        msg: "Starting benchmark execution for {{ client_name }}..."

    - name: Execute benchmark run
      ansible.builtin.shell: |
        # Activate virtualenv if it exists
        if [ -d .venv ]; then
          source .venv/bin/activate
        fi
        # Run benchmark with timeout
        timeout 7200 {{ run_command }}
      args:
        chdir: "{{ workspace_root }}/{{ benchmark_source_dir }}"
        executable: /bin/bash
      environment:
        JWT_PATH: "{{ benchmark_jwt_path }}"
        PYTHONPATH: "{{ workspace_root }}/{{ benchmark_source_dir }}"
      register: run_result
      changed_when: true
      async: 7200
      poll: 30

    - name: Log benchmark execution end
      ansible.builtin.debug:
        msg: "Benchmark execution completed for {{ client_name }} with exit code {{ run_result.rc }}"

    - name: Check if benchmark succeeded
      ansible.builtin.assert:
        that:
          - run_result.rc == 0
        fail_msg: "Benchmark execution failed for {{ client_name }}: {{ run_result.stderr }}"
        success_msg: "Benchmark execution succeeded for {{ client_name }}"

    - name: Register client success
      ansible.builtin.set_fact:
        client_execution_status:
          client: "{{ client_name }}"
          status: "success"
          return_code: "{{ run_result.rc }}"
          stdout: "{{ run_result.stdout }}"

  rescue:
    - name: Log benchmark failure
      ansible.builtin.debug:
        msg: "Failed to execute benchmarks for {{ client_name }}: {{ ansible_failed_result.msg | default('Unknown error') }}"

    - name: Register client failure
      ansible.builtin.set_fact:
        client_execution_status:
          client: "{{ client_name }}"
          status: "failed"
          error_message: "{{ ansible_failed_result.msg | default('Unknown error') }}"
          return_code: "{{ run_result.rc | default(-1) }}"
          stderr: "{{ run_result.stderr | default('') }}"

    - name: Mark this client as failed
      ansible.builtin.fail:
        msg: "Benchmark execution failed for {{ client_name }}"

  always:
    - name: Collect Docker logs for client
      ansible.builtin.shell: |
        set -e
        log_dir="{{ workspace_root }}/{{ benchmark_logs_dir }}/{{ client_name }}"
        mkdir -p "$log_dir"

        # Get list of containers for this client
        containers=$(docker ps -a --filter "name={{ client_name }}" --format "{{ '{{' }}.Names{{ '}}' }}" 2>/dev/null || true)

        if [ -n "$containers" ]; then
          for container in $containers; do
            echo "Collecting logs for container: $container"
            docker logs "$container" > "$log_dir/${container}.log" 2>&1 || true
          done
          echo "Logs collected for {{ client_name }}"
        else
          echo "No containers found for {{ client_name }}"
        fi
      args:
        executable: /bin/bash
      register: log_collection_result
      changed_when: "'Logs collected' in log_collection_result.stdout"
      failed_when: false

    - name: Check reports directory for generated artifacts
      ansible.builtin.find:
        paths: "{{ workspace_root }}/{{ benchmark_source_dir }}/reports"
        file_type: file
      register: reports_files
      failed_when: false

    - name: Fail if no reports were generated
      ansible.builtin.fail:
        msg: "Benchmark validation failed: reports directory is empty or missing (expected HTML reports in gas-benchmarks/reports/)"
      when: (reports_files.matched | default(0)) == 0

    - name: Log validation success
      ansible.builtin.debug:
        msg: "Benchmark validation passed: {{ reports_files.matched }} report files generated"
      when: reports_files.matched > 0

    - name: Copy results artifacts from gas-benchmarks to top-level
      ansible.builtin.synchronize:
        src: "{{ workspace_root }}/{{ benchmark_source_dir }}/results/"
        dest: "{{ workspace_root }}/results/"
        mode: push
        delete: no
        recursive: yes
      delegate_to: "{{ inventory_hostname }}"
      register: results_sync_result
      failed_when: false

    - name: Copy reports artifacts from gas-benchmarks to top-level
      ansible.builtin.synchronize:
        src: "{{ workspace_root }}/{{ benchmark_source_dir }}/reports/"
        dest: "{{ workspace_root }}/reports/"
        mode: push
        delete: no
        recursive: yes
      delegate_to: "{{ inventory_hostname }}"
      register: reports_sync_result
      failed_when: false

    - name: Copy logs artifacts from gas-benchmarks to top-level
      ansible.builtin.synchronize:
        src: "{{ workspace_root }}/{{ benchmark_source_dir }}/logs/"
        dest: "{{ workspace_root }}/logs/"
        mode: push
        delete: no
        recursive: yes
      delegate_to: "{{ inventory_hostname }}"
      register: logs_sync_result
      failed_when: false

    - name: Log artifact collection summary
      ansible.builtin.debug:
        msg: |
          Artifact collection completed:
          - Results: {{ 'copied' if results_sync_result.changed else 'no changes' }}
          - Reports: {{ 'copied' if reports_sync_result.changed else 'no changes' }}
          - Logs: {{ 'copied' if logs_sync_result.changed else 'no changes' }}

    - name: Fetch artifacts to local machine (remote execution only)
      when: inventory_hostname != 'localhost' and inventory_hostname != '127.0.0.1'
      block:
        - name: Ensure local results directory exists
          ansible.builtin.file:
            path: "{{ local_artifacts_dir }}/results"
            state: directory
            mode: '0755'
          delegate_to: localhost

        - name: Ensure local reports directory exists
          ansible.builtin.file:
            path: "{{ local_artifacts_dir }}/reports"
            state: directory
            mode: '0755'
          delegate_to: localhost

        - name: Ensure local logs directory exists
          ansible.builtin.file:
            path: "{{ local_artifacts_dir }}/logs"
            state: directory
            mode: '0755'
          delegate_to: localhost

        - name: Fetch results from remote to local
          ansible.posix.synchronize:
            src: "{{ workspace_root }}/results/"
            dest: "{{ local_artifacts_dir }}/results/"
            mode: pull
            recursive: yes
          delegate_to: localhost
          register: fetch_results
          failed_when: false

        - name: Fetch reports from remote to local
          ansible.posix.synchronize:
            src: "{{ workspace_root }}/reports/"
            dest: "{{ local_artifacts_dir }}/reports/"
            mode: pull
            recursive: yes
          delegate_to: localhost
          register: fetch_reports
          failed_when: false

        - name: Fetch logs from remote to local
          ansible.posix.synchronize:
            src: "{{ workspace_root }}/logs/"
            dest: "{{ local_artifacts_dir }}/logs/"
            mode: pull
            recursive: yes
          delegate_to: localhost
          register: fetch_logs
          failed_when: false

        - name: Log remote artifact fetch summary
          ansible.builtin.debug:
            msg: |
              Remote artifacts fetched to {{ local_artifacts_dir }}/:
              - Results: {{ 'fetched' if fetch_results.changed else 'no changes' }}
              - Reports: {{ 'fetched' if fetch_reports.changed else 'no changes' }}
              - Logs: {{ 'fetched' if fetch_logs.changed else 'no changes' }}
