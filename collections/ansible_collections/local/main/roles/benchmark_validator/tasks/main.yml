---
# Role: benchmark_validator
# Description: Validates prerequisites and configuration before benchmark execution

- name: Validate Docker is installed
  ansible.builtin.command: docker --version
  register: docker_version_result
  changed_when: false
  failed_when: docker_version_result.rc != 0

- name: Parse Docker version
  ansible.builtin.set_fact:
    docker_version: "{{ docker_version_result.stdout | regex_search('([0-9]+\\.[0-9]+)', '\\1') | first }}"

- name: Fail if Docker version is too old
  ansible.builtin.fail:
    msg: "Docker not installed or version too old (found: {{ docker_version }}, required: >= 20.10)"
  when: docker_version is version('20.10', '<')

- name: Validate Docker Compose is installed
  ansible.builtin.command: docker compose version
  register: docker_compose_version_result
  changed_when: false
  failed_when: docker_compose_version_result.rc != 0

- name: Parse Docker Compose version
  ansible.builtin.set_fact:
    docker_compose_version: "{{ docker_compose_version_result.stdout | regex_search('v?([0-9]+\\.[0-9]+)', '\\1') | first }}"

- name: Fail if Docker Compose version is too old
  ansible.builtin.fail:
    msg: "Docker Compose not installed or version too old (found: {{ docker_compose_version }}, required: >= 2.0)"
  when: docker_compose_version is version('2.0', '<')

- name: Validate Docker daemon is running
  ansible.builtin.command: docker ps
  register: docker_ps_result
  changed_when: false
  failed_when: docker_ps_result.rc != 0

- name: Fail if Docker daemon is not running
  ansible.builtin.fail:
    msg: "Docker daemon not running or permission denied"
  when: docker_ps_result.rc != 0

- name: Validate Python is installed
  ansible.builtin.command: python3 --version
  register: python_version_result
  changed_when: false
  failed_when: python_version_result.rc != 0

- name: Parse Python version
  ansible.builtin.set_fact:
    python_version: "{{ python_version_result.stdout | regex_search('([0-9]+\\.[0-9]+)', '\\1') | first }}"

- name: Fail if Python version is too old
  ansible.builtin.fail:
    msg: "Python 3.10+ not installed (found: {{ python_version }})"
  when: python_version is version('3.10', '<')

- name: Validate jq is installed
  ansible.builtin.command: jq --version
  register: jq_version_result
  changed_when: false
  failed_when: jq_version_result.rc != 0

- name: Fail if jq is not installed
  ansible.builtin.fail:
    msg: "jq not installed (required for JSON processing)"
  when: jq_version_result.rc != 0

- name: Check available disk space
  ansible.builtin.shell: |
    df -k {{ workspace_root }} | tail -1 | awk '{print $4}'
  register: disk_space_kb_result
  changed_when: false
  failed_when: false

- name: Convert disk space to GB
  ansible.builtin.set_fact:
    disk_space_gb: "{{ (disk_space_kb_result.stdout | int / 1024 / 1024) | round(1, 'floor') | int }}"

- name: Warn if disk space is low
  ansible.builtin.debug:
    msg: "WARNING: Low disk space detected ({{ disk_space_gb }}G available). Benchmarks may require 10G+ for results and logs."
  when: disk_space_gb | int < 10

- name: Fail if disk space is critically low
  ansible.builtin.fail:
    msg: "Insufficient disk space ({{ disk_space_gb }}G available, minimum 5G required)"
  when: disk_space_gb | int < 5

- name: Validate run.sh exists and is executable
  ansible.builtin.stat:
    path: "{{ workspace_root }}/{{ benchmark_source_dir }}/run.sh"
  register: run_sh_stat

- name: Fail if run.sh not found
  ansible.builtin.fail:
    msg: "{{ benchmark_source_dir }}/run.sh not found (check benchmark_source_dir variable)"
  when: not run_sh_stat.stat.exists

- name: Fail if run.sh is not executable
  ansible.builtin.fail:
    msg: "{{ benchmark_source_dir }}/run.sh exists but is not executable"
  when: run_sh_stat.stat.exists and not run_sh_stat.stat.executable

- name: Validate setup_node.py exists
  ansible.builtin.stat:
    path: "{{ workspace_root }}/{{ benchmark_source_dir }}/setup_node.py"
  register: setup_node_stat

- name: Fail if setup_node.py not found
  ansible.builtin.fail:
    msg: "{{ benchmark_source_dir }}/setup_node.py not found"
  when: not setup_node_stat.stat.exists

- name: Validate requirements.txt exists
  ansible.builtin.stat:
    path: "{{ workspace_root }}/{{ benchmark_source_dir }}/requirements.txt"
  register: requirements_stat

- name: Fail if requirements.txt not found
  ansible.builtin.fail:
    msg: "{{ benchmark_source_dir }}/requirements.txt not found"
  when: not requirements_stat.stat.exists

- name: Validate client directories exist
  ansible.builtin.stat:
    path: "{{ workspace_root }}/{{ benchmark_source_dir }}/scripts/{{ item }}"
  register: client_dir_stats
  loop: "{{ benchmark_clients }}"
  failed_when: not client_dir_stats.stat.exists

- name: Fail if client directory not found
  ansible.builtin.fail:
    msg: "Client directory not found: {{ benchmark_source_dir }}/scripts/{{ item.item }}"
  when: not item.stat.exists
  loop: "{{ client_dir_stats.results }}"
  loop_control:
    label: "{{ item.item }}"

- name: Validate client docker-compose.yaml exists
  ansible.builtin.stat:
    path: "{{ workspace_root }}/{{ benchmark_source_dir }}/scripts/{{ item }}/docker-compose.yaml"
  register: docker_compose_stats
  loop: "{{ benchmark_clients }}"

- name: Fail if docker-compose.yaml not found for client
  ansible.builtin.fail:
    msg: "docker-compose.yaml not found for client {{ item.item }}"
  when: not item.stat.exists
  loop: "{{ docker_compose_stats.results }}"
  loop_control:
    label: "{{ item.item }}"

- name: Validate test paths exist
  ansible.builtin.stat:
    path: "{{ workspace_root }}/{{ item.path }}"
  register: test_path_stats
  loop: "{{ benchmark_test_paths }}"
  loop_control:
    label: "{{ item.path }}"

- name: Fail if test path not found
  ansible.builtin.fail:
    msg: "Test path not found: {{ item.item.path }}"
  when: not item.stat.exists
  loop: "{{ test_path_stats.results }}"
  loop_control:
    label: "{{ item.item.path }}"

- name: Validate warmup file exists (if specified)
  ansible.builtin.stat:
    path: "{{ workspace_root }}/{{ benchmark_warmup_file }}"
  register: warmup_file_stat
  when: benchmark_warmup_file is defined and benchmark_warmup_file != ""

- name: Fail if warmup file not found
  ansible.builtin.fail:
    msg: "Warmup file not found: {{ benchmark_warmup_file }}"
  when:
    - benchmark_warmup_file is defined
    - benchmark_warmup_file != ""
    - not warmup_file_stat.stat.exists

- name: Normalize benchmark_clients to ensure it's a list  
  block:
    - name: Convert Python list string to JSON and parse
      ansible.builtin.set_fact:
        benchmark_clients_normalized: "{{ benchmark_clients | replace(\"'\", '\"') | from_json }}"
      when: benchmark_clients is string
    
    - name: Use benchmark_clients as-is if it's already a list
      ansible.builtin.set_fact:
        benchmark_clients_normalized: "{{ benchmark_clients }}"
      when: benchmark_clients is not string

- name: Validate genesis files exist for each client
  ansible.builtin.stat:
    path: "{{ workspace_root }}/{{ benchmark_source_dir }}/scripts/genesisfiles/{{ item[0] }}/{{ item[1].genesis }}"
  register: genesis_file_stats
  loop: "{{ benchmark_clients_normalized | product(benchmark_test_paths | selectattr('genesis', 'defined') | list) | list }}"
  loop_control:
    label: "{{ item[0] }}/{{ item[1].genesis }}"
  when: item[1].genesis is defined

- name: Fail if genesis file not found
  ansible.builtin.fail:
    msg: "Genesis file not found: {{ item.item[1].genesis }} for client {{ item.item[0] }}"
  when: not item.stat.exists
  loop: "{{ genesis_file_stats.results }}"
  loop_control:
    label: "{{ item.item[0] }}/{{ item.item[1].genesis }}"

- name: Install Python dependencies
  ansible.builtin.pip:
    requirements: "{{ workspace_root }}/{{ benchmark_source_dir }}/requirements.txt"
    state: present
    extra_args: --user
  register: pip_install_result

- name: Check if Makefile exists in source directory
  ansible.builtin.stat:
    path: "{{ workspace_root }}/{{ benchmark_source_dir }}/Makefile"
  register: makefile_stat

- name: Prepare tools via Makefile (if exists)
  ansible.builtin.command:
    cmd: make prepare_tools
    chdir: "{{ workspace_root }}/{{ benchmark_source_dir }}"
  register: make_prepare_result
  changed_when: "'up to date' not in make_prepare_result.stdout"
  when: makefile_stat.stat.exists

- name: Register validation results
  ansible.builtin.set_fact:
    validation_results:
      docker_version: "{{ docker_version }}"
      docker_compose_version: "{{ docker_compose_version }}"
      python_version: "{{ python_version }}"
      clients_validated: "{{ benchmark_clients }}"
      test_paths_validated: "{{ benchmark_test_paths | map(attribute='path') | list }}"
      warmup_file_validated: "{{ (benchmark_warmup_file is defined and benchmark_warmup_file != '' and warmup_file_stat.stat.exists) | default(false) }}"
      genesis_files_validated: "{{ genesis_file_stats.results | default([]) | map(attribute='stat.path') | list }}"
