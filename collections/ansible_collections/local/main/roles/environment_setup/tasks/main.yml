---
# Role: environment_setup
# Description: Prepares environment for benchmark execution (directories, lock file, cleanup)

- name: Log environment setup phase
  ansible.builtin.debug:
    msg: "========== Environment Setup Phase =========="

- name: Ensure workspace root directory exists
  ansible.builtin.file:
    path: "{{ workspace_root }}"
    state: directory
    mode: '0755'

- name: Check if gas-benchmarks directory exists
  ansible.builtin.stat:
    path: "{{ workspace_root }}/{{ benchmark_source_dir }}"
  register: gas_benchmarks_stat

- name: Clone gas-benchmarks repository if not present
  ansible.builtin.git:
    repo: "https://github.com/NethermindEth/gas-benchmarks.git"
    dest: "{{ workspace_root }}/{{ benchmark_source_dir }}"
    version: main
    update: yes
  when: not gas_benchmarks_stat.stat.exists

- name: Update gas-benchmarks repository if already present
  ansible.builtin.git:
    repo: "https://github.com/NethermindEth/gas-benchmarks.git"
    dest: "{{ workspace_root }}/{{ benchmark_source_dir }}"
    version: main
    update: yes
    force: yes
  when: gas_benchmarks_stat.stat.exists

- name: Pull LFS files for gas-benchmarks
  ansible.builtin.shell: |
    git lfs install
    git lfs pull
  args:
    chdir: "{{ workspace_root }}/{{ benchmark_source_dir }}"
    executable: /bin/bash
  register: lfs_pull_result
  changed_when: "'Downloading' in lfs_pull_result.stdout or 'Filtering' in lfs_pull_result.stdout"

- name: Check for existing lock file
  ansible.builtin.stat:
    path: "{{ benchmark_lock_file }}"
  register: lock_file_stat

- name: Read lock file content if exists
  ansible.builtin.slurp:
    path: "{{ benchmark_lock_file }}"
  register: lock_file_content
  when: lock_file_stat.stat.exists

- name: Extract PID from lock file
  ansible.builtin.set_fact:
    lock_pid: "{{ (lock_file_content.content | b64decode | regex_search('pid: (\\d+)', '\\1'))[0] | default('0') }}"
  when: lock_file_stat.stat.exists

- name: Check if lock process is still running
  ansible.builtin.shell: |
    ps -p {{ lock_pid }} > /dev/null 2>&1 && echo "running" || echo "not_running"
  register: lock_process_check
  changed_when: false
  failed_when: false
  when: lock_file_stat.stat.exists

- name: Remove stale lock file if process is dead
  ansible.builtin.file:
    path: "{{ benchmark_lock_file }}"
    state: absent
  when:
    - lock_file_stat.stat.exists
    - lock_process_check.stdout | default('') == 'not_running'

- name: Update lock file stat after cleanup
  ansible.builtin.stat:
    path: "{{ benchmark_lock_file }}"
  register: lock_file_stat
  when: 
    - lock_file_stat.stat.exists | default(false)
    - lock_process_check.stdout | default('') == 'not_running'

- name: Fail if valid lock file exists (concurrent execution prevented)
  ansible.builtin.fail:
    msg: "Benchmark execution already in progress (lock file: {{ benchmark_lock_file }}, PID: {{ lock_pid | default('unknown') }})"
  when:
    - lock_file_stat.stat.exists | default(false)
    - (lock_process_check.stdout | default('running')) == 'running'

- name: Get current process PID
  ansible.builtin.shell: echo $$
  register: ansible_pid_output
  changed_when: false

- name: Create lock file
  ansible.builtin.copy:
    content: |
      timestamp: {{ ansible_date_time.iso8601 }}
      pid: {{ ansible_pid_output.stdout | int }}
      playbook_run_id: {{ ansible_run_tags | join(',') | default('no_tags') }}
    dest: "{{ benchmark_lock_file }}"
    mode: '0644'

- name: Clean previous results directories
  ansible.builtin.file:
    path: "{{ workspace_root }}/{{ item }}"
    state: absent
  loop:
    - "{{ benchmark_results_dir }}"
    - "{{ benchmark_preparation_results_dir }}"

- name: Clean gas-benchmarks reports directory before execution
  ansible.builtin.file:
    path: "{{ workspace_root }}/{{ benchmark_source_dir }}/reports"
    state: absent

- name: Create required directories
  ansible.builtin.file:
    path: "{{ workspace_root }}/{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ benchmark_results_dir }}"
    - "{{ benchmark_warmup_results_dir }}"
    - "{{ benchmark_reports_dir }}"
    - "{{ benchmark_logs_dir }}"
    - "{{ benchmark_preparation_results_dir }}"

- name: Check if overlay snapshot mode is enabled
  ansible.builtin.set_fact:
    overlay_mode_enabled: "{{ benchmark_snapshot_root is defined and benchmark_snapshot_root != '' }}"

- name: Clean up stale overlay mounts (if using overlays)
  ansible.builtin.shell: |
    set -e

    # Find all overlay mounts under the overlay runtime directory
    overlay_runtime_path="{{ workspace_root }}/{{ benchmark_overlay_tmp_root }}"

    if [ -d "$overlay_runtime_path" ]; then
      # Find and unmount all overlay filesystems
      find "$overlay_runtime_path" -type d -name "overlay" 2>/dev/null | while read mount_point; do
        if mountpoint -q "$mount_point" 2>/dev/null; then
          echo "Unmounting stale overlay: $mount_point"
          sudo umount "$mount_point" 2>/dev/null || {
            echo "Failed to unmount $mount_point, attempting lazy unmount"
            sudo umount -l "$mount_point" 2>/dev/null || true
          }
        fi
      done

      # Clean up the overlay runtime directory
      rm -rf "$overlay_runtime_path"
    fi

    echo "Overlay cleanup completed"
  args:
    executable: /bin/bash
  when: overlay_mode_enabled
  register: overlay_cleanup_result
  changed_when: "'Unmounting' in overlay_cleanup_result.stdout"
  failed_when: false
