---
# Role: postgres_publisher
# Description: Publishes benchmark results to PostgreSQL database (optional, tag-based)

- name: Check if postgres tag is enabled
  ansible.builtin.meta: noop
  tags:
    - postgres

- name: Execute PostgreSQL publication tasks
  tags:
    - postgres
  block:
    - name: Validate postgres credentials are provided
      ansible.builtin.assert:
        that:
          - postgres_host is defined
          - postgres_host != ""
          - postgres_user is defined
          - postgres_user != ""
          - postgres_password is defined
          - postgres_password != ""
        fail_msg: "PostgreSQL credentials required when --tags postgres is used. Provide via variables or environment: DB_HOST, DB_USER, DB_PASSWORD"
        success_msg: "PostgreSQL credentials validated"

    - name: Check if reports directory exists
      ansible.builtin.stat:
        path: "{{ workspace_root }}/{{ benchmark_reports_dir }}"
      register: reports_dir_stat

    - name: Skip ingestion if reports directory does not exist
      ansible.builtin.debug:
        msg: "Reports directory {{ benchmark_reports_dir }} does not exist. Skipping PostgreSQL ingestion."
      when: not reports_dir_stat.stat.exists

    - name: Find CSV files in reports directory
      ansible.builtin.find:
        paths: "{{ workspace_root }}/{{ benchmark_reports_dir }}"
        patterns: "*.csv"
      register: csv_files
      when: reports_dir_stat.stat.exists

    - name: Skip ingestion if no CSV files found
      ansible.builtin.debug:
        msg: "No CSV files found in {{ benchmark_reports_dir }}. Skipping PostgreSQL ingestion."
      when:
        - reports_dir_stat.stat.exists
        - csv_files.matched == 0

    - name: Proceed with PostgreSQL ingestion
      when:
        - reports_dir_stat.stat.exists
        - csv_files.matched > 0
      block:
        - name: Test PostgreSQL connection
          ansible.builtin.shell: |
            python3 -c "
            import psycopg2
            import os
            import sys

            try:
                conn = psycopg2.connect(
                    host=os.environ['PGHOST'],
                    port=int(os.environ['PGPORT']),
                    user=os.environ['PGUSER'],
                    password=os.environ['PGPASSWORD'],
                    database=os.environ['PGDATABASE'],
                    connect_timeout=int(os.environ.get('PGTIMEOUT', '10'))
                )
                conn.close()
                print('Connection successful')
                sys.exit(0)
            except Exception as e:
                print(f'Connection failed: {e}', file=sys.stderr)
                sys.exit(1)
            "
          args:
            executable: /bin/bash
          environment:
            PGHOST: "{{ postgres_host }}"
            PGPORT: "{{ postgres_port | string }}"
            PGUSER: "{{ postgres_user }}"
            PGPASSWORD: "{{ postgres_password }}"
            PGDATABASE: "{{ postgres_database }}"
            PGTIMEOUT: "{{ postgres_timeout | string }}"
          register: pg_connection_test
          changed_when: false
          no_log: true
          failed_when: false

        - name: Log connection failure and skip ingestion
          ansible.builtin.debug:
            msg: "PostgreSQL database unreachable at {{ postgres_host }}:{{ postgres_port }}. Skipping ingestion."
          when: pg_connection_test.rc != 0

        - name: Check if fill_postgres_db.py script exists
          ansible.builtin.stat:
            path: "{{ workspace_root }}/{{ benchmark_source_dir }}/fill_postgres_db.py"
          register: fill_script_stat
          when: pg_connection_test.rc == 0

        - name: Fail if fill_postgres_db.py script not found
          ansible.builtin.fail:
            msg: "PostgreSQL ingestion script not found: {{ workspace_root }}/{{ benchmark_source_dir }}/fill_postgres_db.py. Ensure submodule is initialized."
          when:
            - pg_connection_test.rc == 0
            - not fill_script_stat.stat.exists

        - name: Ingest results to PostgreSQL
          ansible.builtin.shell: |
            python3 {{ benchmark_source_dir }}/fill_postgres_db.py \
              --db-host "$PGHOST" \
              --db-port "$PGPORT" \
              --db-user "$PGUSER" \
              --db-name "$PGDATABASE" \
              --table-name "{{ postgres_table }}" \
              --db-password "$PGPASSWORD" \
              --reports-dir "{{ benchmark_reports_dir }}"
          args:
            chdir: "{{ workspace_root }}"
            executable: /bin/bash
          environment:
            PGHOST: "{{ postgres_host }}"
            PGPORT: "{{ postgres_port | string }}"
            PGUSER: "{{ postgres_user }}"
            PGPASSWORD: "{{ postgres_password }}"
            PGDATABASE: "{{ postgres_database }}"
          register: ingestion_result
          no_log: true
          changed_when: ingestion_result.rc == 0
          failed_when: false
          when:
            - pg_connection_test.rc == 0
            - fill_script_stat.stat.exists

        - name: Log ingestion success
          ansible.builtin.debug:
            msg: "Successfully ingested results to {{ postgres_host }}/{{ postgres_database }}.{{ postgres_table }}"
          when:
            - pg_connection_test.rc == 0
            - ingestion_result.rc == 0

        - name: Log ingestion failure
          ansible.builtin.debug:
            msg: "Failed to ingest results to PostgreSQL: {{ ingestion_result.stderr }}"
          when:
            - pg_connection_test.rc == 0
            - ingestion_result.rc != 0

  rescue:
    - name: Handle PostgreSQL publication errors
      ansible.builtin.debug:
        msg: "PostgreSQL publication encountered an error but will not fail the playbook: {{ ansible_failed_result.msg | default('Unknown error') }}"
