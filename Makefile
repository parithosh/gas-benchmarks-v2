# Makefile for Ansible project
# Generated by ansible-scaffold

SHELL := /bin/bash
.SHELLFLAGS := -eu -o pipefail -c
.PHONY: help install validate test clean check-deps new-role new-playbook linux-preinstall

# Detect platform
UNAME_S := $(shell uname -s 2>/dev/null || echo unknown)
ifeq ($(UNAME_S),Linux)
    PLATFORM := linux
endif
ifeq ($(UNAME_S),Darwin)
    PLATFORM := macos
endif

# Python and tool paths
PYTHON := python3
VENV_BIN := .venv/bin

# Tool detection
UV := $(shell command -v uv 2>/dev/null)
ANSIBLE := $(shell command -v ansible 2>/dev/null || echo $(VENV_BIN)/ansible)
ANSIBLE_LINT := $(shell command -v ansible-lint 2>/dev/null || echo $(VENV_BIN)/ansible-lint)
YAMLLINT := $(shell command -v yamllint 2>/dev/null || echo $(VENV_BIN)/yamllint)

## help: Show this help message
help:
	@echo "Available targets:"
	@echo "  install       - Set up Python environment and install dependencies"
	@echo "  init-submodule - Initialize gas-benchmarks git submodule"
	@echo "  prepare_tools - Prepare benchmark tools (Docker, Python deps, jq)"
	@echo "  validate      - Run all linting checks (ansible-lint, yamllint)"
	@echo "  test          - Run tests"
	@echo "  new-role      - Create new role (usage: make new-role NAME=rolename)"
	@echo "  new-playbook  - Create new playbook (usage: make new-playbook NAME=playbookname)"
	@echo "  clean         - Remove virtual environment and caches"
	@echo "  check-deps    - Verify all required dependencies are installed"
	@echo "  linux-preinstall - Install prerequisites on Linux (curl, uv, ansible)"

## linux-preinstall: Install prerequisites on Linux (curl, uv, ansible)
linux-preinstall:
	@if [ "$(PLATFORM)" != "linux" ]; then \
		echo "Error: This target is only for Linux systems"; \
		exit 1; \
	fi
	@echo "==> Installing curl..."
	@command -v curl >/dev/null || (sudo apt-get update && sudo apt-get install -y curl)
	@echo "==> Installing uv..."
	@command -v uv >/dev/null || (curl -LsSf https://astral.sh/uv/install.sh | sh)
	@echo "==> Installing ansible..."
	@command -v ansible >/dev/null || (sudo apt-get update && sudo apt-get install -y ansible)
	@echo "✓ Prerequisites installed!"

## install: Set up Python environment
install:
	@echo "==> Setting up Python environment..."
	@if [ -n "$(UV)" ]; then \
		echo "Using uv for dependency management..."; \
		$(UV) venv && \
		$(UV) pip install "ansible-core>=2.15.0" "ansible-lint>=6.22.0" "yamllint>=1.33.0" "pytest>=7.4.0" "molecule>=6.0.0"; \
	else \
		echo "uv not found, using pip..."; \
		$(PYTHON) -m venv .venv && \
		$(VENV_BIN)/pip install --upgrade pip && \
		$(VENV_BIN)/pip install "ansible-core>=2.15.0" "ansible-lint>=6.22.0" "yamllint>=1.33.0" "pytest>=7.4.0" "molecule>=6.0.0"; \
	fi
	@echo "==> Environment ready!"
	@echo "Activate with: source .venv/bin/activate"

## init-submodule: Initialize gas-benchmarks git submodule
init-submodule:
	@echo "==> Initializing gas-benchmarks submodule..."
	@if [ ! -f gas-benchmarks/.git ]; then \
		git submodule init && \
		git submodule update --recursive; \
		echo "✓ Submodule initialized: gas-benchmarks"; \
	else \
		echo "✓ Submodule already initialized"; \
	fi

## update-submodule: Update submodule to specific branch (usage: make update-submodule BRANCH=branchname [SUBMODULE_PATH=gas-benchmarks])
update-submodule:
	@if [ -z "$(BRANCH)" ]; then \
		echo "Error: BRANCH is required. Usage: make update-submodule BRANCH=branchname [SUBMODULE_PATH=gas-benchmarks]"; \
		exit 1; \
	fi
	@SUBMODULE_VAR=$(if $(SUBMODULE_PATH),$(SUBMODULE_PATH),gas-benchmarks); \
	echo "==> Updating submodule $$SUBMODULE_VAR to branch $(BRANCH)..."; \
	git config submodule.$$SUBMODULE_VAR.branch $(BRANCH) && \
	git submodule update --remote $$SUBMODULE_VAR && \
	echo "✓ Submodule $$SUBMODULE_VAR updated to branch $(BRANCH)"

## prepare_tools: Prepare benchmark tools
prepare_tools:
	@echo "==> Checking Docker..."
	@command -v docker >/dev/null || (echo "Error: Docker not found" && exit 1)
	@docker ps >/dev/null 2>&1 || (echo "Error: Docker daemon not running" && exit 1)
	@echo "==> Checking Docker Compose..."
	@docker compose version >/dev/null 2>&1 || (echo "Error: Docker Compose not found" && exit 1)
	@echo "==> Checking jq..."
	@command -v jq >/dev/null || (echo "Error: jq not found. Install with: brew install jq (macOS) or apt install jq (Linux)" && exit 1)
	@echo "==> Installing Python dependencies from gas-benchmarks/requirements.txt..."
	@if [ -f gas-benchmarks/requirements.txt ]; then \
		$(UV) pip install -r gas-benchmarks/requirements.txt; \
	else \
		echo "Warning: gas-benchmarks/requirements.txt not found. Skipping Python deps."; \
	fi
	@echo "✓ All tools prepared!"

## check-deps: Verify dependencies
check-deps:
	@echo "==> Checking dependencies..."
	@command -v $(PYTHON) >/dev/null || (echo "Error: python3 not found" && exit 1)
	@command -v make >/dev/null || (echo "Error: make not found" && exit 1)
	@[ -d .venv ] || (echo "Error: Virtual environment not found. Run 'make install' first." && exit 1)
	@$(VENV_BIN)/ansible --version >/dev/null || (echo "Error: ansible not found in venv" && exit 1)
	@$(VENV_BIN)/ansible-lint --version >/dev/null || (echo "Error: ansible-lint not found in venv" && exit 1)
	@$(VENV_BIN)/yamllint --version >/dev/null || (echo "Error: yamllint not found in venv" && exit 1)
	@echo "✓ All dependencies satisfied!"

## validate: Run linting checks
validate: check-deps
	@echo "==> Running ansible-lint..."
	@$(VENV_BIN)/ansible-lint . || (echo "✗ ansible-lint failed" && exit 1)
	@echo "==> Running yamllint..."
	@$(VENV_BIN)/yamllint . || (echo "✗ yamllint failed" && exit 1)
	@echo "✅ All validation checks passed!"

## test: Run tests
test: check-deps
	@echo "==> Running tests..."
	@$(VENV_BIN)/pytest tests/ -v

## new-role: Create new role
new-role:
	@if [ -z "$(NAME)" ]; then \
		echo "Error: NAME is required. Usage: make new-role NAME=rolename"; \
		exit 1; \
	fi
	@echo "==> Creating role $(NAME)..."
	@$(VENV_BIN)/ansible-galaxy role init \
		--init-path collections/ansible_collections/local/main/roles \
		$(NAME)
	@echo "✓ Role created at collections/ansible_collections/local/main/roles/$(NAME)"

## new-playbook: Create new playbook
new-playbook:
	@if [ -z "$(NAME)" ]; then \
		echo "Error: NAME is required. Usage: make new-playbook NAME=playbookname"; \
		exit 1; \
	fi
	@echo "==> Creating playbook $(NAME).yml..."
	@mkdir -p collections/ansible_collections/local/main/playbooks
	@echo "---" > collections/ansible_collections/local/main/playbooks/$(NAME).yml
	@echo "- name: $(NAME)" >> collections/ansible_collections/local/main/playbooks/$(NAME).yml
	@echo "  hosts: all" >> collections/ansible_collections/local/main/playbooks/$(NAME).yml
	@echo "  tasks:" >> collections/ansible_collections/local/main/playbooks/$(NAME).yml
	@echo "    - name: Example task" >> collections/ansible_collections/local/main/playbooks/$(NAME).yml
	@echo "      ansible.builtin.debug:" >> collections/ansible_collections/local/main/playbooks/$(NAME).yml
	@echo "        msg: 'Hello from $(NAME)'" >> collections/ansible_collections/local/main/playbooks/$(NAME).yml
	@echo "✓ Playbook created at collections/ansible_collections/local/main/playbooks/$(NAME).yml"

## clean: Remove virtual environment and caches
clean:
	@echo "==> Cleaning up..."
	@rm -rf .venv/
	@rm -rf __pycache__/
	@rm -rf .pytest_cache/
	@rm -rf .ansible/
	@find . -type f -name '*.pyc' -delete
	@find . -type d -name '__pycache__' -delete
	@echo "✓ Cleanup complete"
